<div class="container mt-5">
    <!-- Encabezado con bot√≥n Volver -->
    <div class="d-flex align-items-center mb-4">
        <a routerLink="/" class="btn btn-outline-secondary me-3">‚¨Ö Volver al Dashboard</a>
        <h1 class="text-primary m-0">üë• Gesti√≥n de Clientes</h1>
    </div>

    <!-- TARJETA DE B√öSQUEDA -->
    <div class="card shadow-sm mb-5">
        <div class="card-body p-4">
            <label class="form-label fw-bold">Buscar Cliente</label>
            <div class="input-group input-group-lg">
                <span class="input-group-text bg-white">üîç</span>
                <!-- Input conectado con ngModel -->
                <input type="text" class="form-control" 
                       [(ngModel)]="terminoBusqueda" 
                       (keyup.enter)="buscar()"
                       placeholder="Escribe un nombre (ej: Juan) o correo...">
                
                <button class="btn btn-primary px-4" (click)="buscar()" [disabled]="buscando">
                    {{ buscando ? 'Buscando...' : 'Buscar' }}
                </button>
            </div>
            <!-- Mensajes de Ayuda / Error -->
            <small class="text-muted mt-2 d-block" *ngIf="!errorMsg">Presiona Enter para buscar.</small>
            <div *ngIf="errorMsg" class="alert alert-warning mt-3 mb-0">
                {{ errorMsg }}
            </div>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div *ngIf="clientes.length > 0" class="animate__animated animate__fadeIn">
        <h3 class="mb-3">Resultados encontrados <span class="badge bg-secondary">{{ clientes.length }}</span></h3>
        
        <div class="table-responsive shadow rounded">
            <table class="table table-hover mb-0 bg-white align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre Completo</th>
                        <th>Email</th>
                        <th>Ciudad</th>
                        <th>Edad</th>
                        <th>G√©nero</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let c of clientes">
                        <td>{{ c.id_cliente_nk }}</td>
                        
                        <!-- Nombre con click para abrir modal -->
                        <td>
                            <a href="javascript:void(0)" 
                               class="text-primary fw-bold text-decoration-none"
                               (click)="verDetalleCliente(c)">
                                {{ c.nombre_completo }} <i class="bi bi-eye-fill ms-1 small"></i>
                            </a>
                        </td>

                        <td>{{ c.email }}</td>
                        <td>{{ c.ciudad }}</td>
                        <td>
                            <span class="badge bg-info text-dark">{{ c.edad }} a√±os</span>
                        </td>
                        <td>{{ c.genero }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL DE DETALLE (CON DATOS SQL) -->
<!-- ========================================== -->

<!-- Fondo oscuro (Backdrop) -->
<div class="modal-backdrop fade show" *ngIf="mostrarModal"></div>

<!-- Ventana Modal -->
<div class="modal fade show d-block" tabindex="-1" *ngIf="mostrarModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      
      <!-- HEADER -->
      <div class="modal-header bg-primary text-white border-0">
        <div class="d-flex align-items-center gap-3">
          <!-- Inicial del nombre -->
          <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" 
               style="width: 50px; height: 50px; font-size: 1.5rem;">
            {{ selectedCliente?.nombre_completo?.charAt(0) }}
          </div>
          <div>
            <h5 class="modal-title mb-0 fw-bold">{{ selectedCliente?.nombre_completo }}</h5>
            <div class="opacity-75 small">
              <i class="bi bi-envelope me-1"></i> {{ selectedCliente?.email }}
            </div>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body bg-light">
        
        <!-- 1. KPIs Resumen -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3 text-center h-100">
              <div class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Gasto Total (Calculado)</div>
              <!-- Muestra el total calculado desde el SQL -->
              <div class="fs-4 fw-bold text-success">{{ selectedCliente?.totalGastado | currency }}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3 text-center h-100">
              <div class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Edad</div>
              <div class="fs-4 fw-bold text-dark">
                {{ selectedCliente?.edad }} <span class="fs-6 text-muted fw-normal">a√±os</span>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3 text-center h-100">
              <div class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Ciudad</div>
              <div class="fs-4 fw-bold text-primary">{{ selectedCliente?.ciudad }}</div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- 2. Datos de Contacto (Simulados en TS) -->
          <div class="col-md-5 mb-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white fw-bold border-bottom-0 pt-3">
                <i class="bi bi-person-lines-fill me-2 text-primary"></i> Datos de Contacto
              </div>
              <div class="card-body pt-0">
                <ul class="list-unstyled mb-0">
                  <li class="mb-3">
                    <small class="text-muted d-block">Direcci√≥n</small>
                    <span class="fw-medium">{{ selectedCliente?.direccion }}</span>
                  </li>
                  <li class="mb-3">
                    <small class="text-muted d-block">Tel√©fono</small>
                    <span class="fw-medium">{{ selectedCliente?.telefono }}</span>
                  </li>
                   <li>
                    <small class="text-muted d-block">Estado</small>
                    <span class="badge bg-success-subtle text-success border border-success">Activo</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <!-- 3. Historial de Compras (Datos Reales desde SQL) -->
          <div class="col-md-7 mb-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white fw-bold border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
                <span><i class="bi bi-cart3 me-2 text-primary"></i> Compras Recientes</span>
                
                <!-- Spinner de carga -->
                <div *ngIf="cargandoCompras" class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
              </div>
              
              <div class="card-body p-0 table-responsive">
                
                <!-- Mensaje si no hay datos o est√° cargando -->
                <div *ngIf="!cargandoCompras && selectedCliente?.ultimasCompras?.length === 0" class="p-4 text-center text-muted small">
                   No se encontraron registros de ventas para este cliente.
                </div>

                <!-- Tabla SQL -->
                <table class="table table-hover mb-0 align-middle text-sm" 
                       *ngIf="selectedCliente?.ultimasCompras?.length > 0"
                       [class.opacity-50]="cargandoCompras">
                  <thead class="bg-light text-muted">
                    <tr>
                      <th class="ps-3 border-0">Producto</th>
                      <th class="border-0 text-center">Cant.</th>
                      <th class="border-0">Fecha</th>
                      <th class="border-0 text-end pe-3">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let venta of selectedCliente.ultimasCompras">
                      <!-- Campos que vienen del SQL -->
                      <td class="ps-3 fw-medium text-dark">{{ venta.nombre_producto }}</td>
                      <td class="text-center">{{ venta.cantidad }}</td>
                      <td class="text-muted">{{ venta.fecha_venta | date:'shortDate' }}</td>
                      <td class="text-end pe-3 fw-bold text-dark">{{ venta.total_ventas | currency }}</td>
                    </tr>
                  </tbody>
                  <!-- PIE DE TABLA CON TOTAL ACUMULADO -->
                  <tfoot class="bg-light border-top">
                    <tr>
                      <td colspan="3" class="text-end fw-bold text-muted text-uppercase pt-3">Total Acumulado:</td>
                      <td class="text-end pe-3 fw-bolder text-success fs-6 pt-3">
                        {{ selectedCliente?.totalGastado | currency }}
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer bg-white border-top-0 justify-content-center pb-4">
        <button class="btn btn-secondary px-5" (click)="cerrarModal()">
          Cerrar Vista
        </button>
      </div>

    </div>
  </div>
</div>